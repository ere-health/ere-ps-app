
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ere.health COVID-19 Zertifikate drucken</title>
    <link rel="stylesheet" href="../frontend/app/src/assets/css/main-style.css">
    <link rel="stylesheet" href="certificate.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript">
    function sendVacinationRequest() {
        const form = document.getElementById("vacination-request-form");

        if (!form.reportValidity()) {
            return;
        }

        const oVacinationRequest = {
            "nam": {
            "fn": form.elements["fn"].value,
            "gn": form.elements["gn"].value
            },
            "dob": form.elements["dob"].value,
            "v": [
            {
                "tg": form.elements["tg"].value,
                "vp": form.elements["vp"].value,
                "mp": form.elements["mp"].value,
                "ma": form.elements["ma"].value,
                "dn": parseInt(form.elements["dn"].value),
                "sd": parseInt(form.elements["sd"].value),
                "dt": form.elements["dt"].value
            }
            ]
        };
        fetch("/api/certify/v2/issue", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(oVacinationRequest)
        }).then(function(response) {
            return response.arrayBuffer();
        }).then(function(buffer) {
            const blob = new Blob([buffer]);
            const blobUrl = URL.createObjectURL(blob);
            window.location = blobUrl;
        });
    }

    function prefillParameters() {
        const form = document.getElementById("vacination-request-form");

        // remove '#' from hash
        const params = new URLSearchParams(window.location.hash.substring(1));

        for (const name of ["fn", "gn", "dob", "tg", "vp", "mp", "ma", "dn", "sd", "sd"]) {
            // setting the values to null will cause the validation to be triggered
            if (params.has(name)) {
                form.elements[name].value = params.get(name);
            }
        }
    }
    </script>
</head>
<body class="home-page" onload="prefillParameters();" onhashchange="prefillParameters();">
    <div class="main-content-wrapper">
        <header class="header-wrapper">
            <div class="header">
            <div class="logo">
                <img
                    src = "../frontend/app/src/assets/images/ere.health-logo.svg"
                    alt = "ere.health Logo"
                />
            </div>
            </div>
        </header>
        <section class="recipe-body dgn-body">
            <div class="recipe-wrapper active" id="unsigned_1">
                <div class="title-rezept-button">
                  <h2><strong>COVID-19 Impfzertifikat</strong></h2>
                  <button id="sign-recipe" onclick="sendVacinationRequest();" class="open-modal jet-btn fixed-right" style="">
                    Zertifikat erstellen
                  </button>
                </div>
                <form id="vacination-request-form">
                    <fieldset>
                        <legend>Patientendaten</legend>

                        <label for="gn">Vorname</label>
                        <input type="text" id="gn" name="gn"/>
                        <br />

                        <label for="fn">Nachname</label>
                        <input type="text" id="fn" name="fn" required/>
                        <br />

                        <label for="dob">Geburtsdatum</label>
                        <input type="date" id="dob" name="dob" placeolder="e.g. 1970-01-16" required/>
                        <br />
                    </fieldset>
                    <fieldset>
                        <legend>Impfdaten</legend>

                        <label for="tg">Krankheit</label>
                        <input type="text" id="tg" name="tg" placeholder="e.g. 840539006 for COVID-19" required/>
                        <br/>

                        <label for="vp">Impfstoff</label>
                        <input type="text" id="vp" name="vp" placeholder="e.g. 11193050005" required/>
                        <br/>

                        <label for="mp">Produkt</label>
                        <input type="text" id="mp" name="mp" placeholder="e.g. EU/1/20/1528 for Comirnaty" required/>
                        <br/>

                        <label for="ma">Hersteller</label>
                        <input type="text" id="ma" name="ma"
                               placeholder="e.g. ORG-100030215 for Biontech Manufacturing GmbH" required/>
                        <br/>

                        <label for="dn">Dosennummer</label>
                        <input type="text" id="dn" name="dn" placeholder="e.g. 1" required/>
                        <br/>

                        <label for="sd">Gesamtdosen</label>
                        <input type="text" id="sd" name="sd" placeholder="e.g. 2" required/>
                        <br/>

                        <label for="dt">Impfdatum</label>
                        <input type="date" id="dt" name="dt" placeholder="e.g. 2021-12-31" required/>
                        <br/>
                    </fieldset>
                </form>
            </div>
        </section>
    </div>
</body>
</html>
